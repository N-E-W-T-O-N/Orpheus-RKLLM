import numpy as np
import soundfile as sf

import onnxruntime as ort

# Output()


session = ort.InferenceSession("decoder_model.onnx", providers=['CPUExecutionProvider'])


def create_codes(generated_ids):
    token_to_find = 128257
    token_to_remove = 128258
    # Find indices where token_to_find appears
    # Return index where the values are repeated Array(0, , ), Array(i, j, k)
    token_indices = np.where(
        generated_ids == token_to_find)  # (generated_ids == token_to_find).nonzero(as_tuple = True)

    # if len(token_indices[1]) > 0:
    if len(token_indices[1]) > 0:
        last_occurrence_idx = token_indices[1][- 1]  # [1][- 1].item()
        cropped_tensor = generated_ids[:, last_occurrence_idx + 1:]
    else:
        cropped_tensor = generated_ids
    cropped_tensor = np.array(cropped_tensor)
    processed_rows = np.delete(cropped_tensor, np.where(cropped_tensor == token_to_remove))

    row_length = processed_rows.shape[0]
    new_length = (row_length // 7) * 7
    processed_rows = processed_rows[:new_length]
    trimmed_row = [t - 128266 for t in processed_rows]  # subtract offset code_lists.append(trimmed_row)

    return trimmed_row


def run_onnx(code_list):
    layer_1 = []
    layer_2 = []
    layer_3 = []
    for i in range((len(code_list) + 1) // 7):
        layer_1.append(code_list[7 * i])
        layer_2.append(code_list[7 * i + 1] - 4096)
        layer_3.append(code_list[7 * i + 2] - (2 * 4096))
        layer_3.append(code_list[7 * i + 3] - (3 * 4096))
        layer_2.append(code_list[7 * i + 4] - (4 * 4096))
        layer_3.append(code_list[7 * i + 5] - (5 * 4096))
        layer_3.append(code_list[7 * i + 6] - (6 * 4096))
        # codes = [torch.tensor(layer_1).unsqueeze(0),
        # torch.tensor(layer_2).unsqueeze(0),
        # torch.tensor(layer_3).unsqueeze(0)]
    codes = [np.expand_dims(np.array(layer_1, dtype=np.int64), axis=0),
             np.expand_dims(np.array(layer_2, dtype=np.int64), axis=0),
             np.expand_dims(np.array(layer_3, dtype=np.int64), axis=0)]

    inputs = {"audio_codes.0": np.expand_dims(np.array(layer_1, dtype=np.int64), axis=0),
              "audio_codes.1": np.expand_dims(np.array(layer_2, dtype=np.int64), axis=0),
              "audio_codes.2": np.expand_dims(np.array(layer_3, dtype=np.int64), axis=0)}
    output = session.run(None, inputs)
    audio_hat = output[0]
    return audio_hat


def redistribute_codes_old(code_list):
    code_array = np.array(code_list, dtype=np.int64)

    num_blocks = (len(code_array) + 1) // 7

    layer_1 = code_array[::7][:num_blocks]
    layer_2 = np.concatenate([code_array[1::7][:num_blocks] - 4096, code_array[4::7][:num_blocks] - 4 * 4096])
    layer_3 = np.concatenate([code_array[2::7][:num_blocks] - 2 * 4096, code_array[3::7][:num_blocks] - 3 * 4096,
                              code_array[5::7][:num_blocks] - 5 * 4096, code_array[6::7][:num_blocks] - 6 * 4096])

    layer_1_array = layer_1[np.newaxis, :]
    layer_2_array = layer_2[np.newaxis, :]
    layer_3_array = layer_3[np.newaxis, :]

    inputs = {"audio_codes.0": layer_1_array.astype(np.int64), "audio_codes.1": layer_2_array.astype(np.int64),
              "audio_codes.2": layer_3_array.astype(np.int64), }

    output = session.run(None, inputs)
    return output[0]


def create_audio(waveform, name="output.wav"):
    # samples = redistribute_codes_old(code_list)
    print(waveform.shape)
    sf.write(name, waveform, samplerate=24000)


if __name__ == "__main__":
    generated_id = np.array(
        [[128261, 128257, 132247, 132788, 140367, 144531, 147076, 150314, 156264, 130334, 134098, 139880, 143976,
          146386,
          152168, 154410, 132151, 135924, 140109, 143985, 145313, 151523, 154653, 131765, 135280, 138828, 142924,
          147568,
          151116, 155212, 128983, 133457, 136619, 140715, 146054, 150557, 153271, 128868, 133025, 137214, 140983,
          145606,
          149175, 155425, 130334, 134971, 136613, 140709, 147259, 150071, 154356, 131172, 133766, 137630, 142085,
          147974,
          150046, 153031, 128845, 135686, 137972, 142584, 144681, 150918, 155014, 131413, 134290, 138488, 142068,
          146578,
          150776, 154872, 131337, 136003, 138630, 142726, 148291, 150382, 154478, 130998, 132938, 136887, 144463,
          145391,
          150413, 153003, 132185, 136443, 137593, 141689, 148731, 149881, 153977, 131765, 134893, 138847, 144572,
          145844,
          148971, 155398, 131289, 136049, 138704, 143266, 145729, 151458, 155554, 131015, 136343, 139170, 144564,
          148631,
          152756, 156852, 129619, 134174, 137303, 141399, 145079, 151250, 153687, 130639, 132791, 139098, 142468,
          146000,
          152674, 156770, 130636, 134447, 140386, 141463, 145161, 149655, 153751, 131020, 136360, 140206, 140608,
          145139,
          151093, 155189, 131542, 135181, 137367, 144333, 146335, 150260, 154356, 130334, 133766, 140476, 141891,
          147259,
          149175, 155755, 130998, 133676, 139964, 143712, 148200, 152764, 156860, 131337, 135912, 137142, 143645,
          144961,
          150232, 154328, 131413, 132673, 137944, 142040, 146760, 150382, 155108, 132185, 136443, 138630, 142221,
          148731,
          150413, 153977, 128983, 135780, 136887, 140983, 148068, 150918, 155014, 131765, 134893, 136706, 144482,
          146875,
          149491, 154171, 130193, 134587, 140386, 143626, 148631, 149036, 153132, 130863, 134447, 139051, 143147,
          146735,
          151339, 155435, 130029, 136360, 137367, 141463, 145431, 152674, 156550, 129290, 134701, 139534, 142930,
          148169,
          150495, 153048, 129376, 134523, 138819, 143324, 147205, 150032, 156401, 131591, 133973, 138036, 142147,
          146079,
          149592, 155272, 129967, 132394, 139883, 140735, 146253, 151814, 152851, 131428, 135167, 139356, 141072,
          147455,
          152805, 155926, 130491, 135086, 137127, 141546, 147374, 151199, 153511, 131087, 134225, 139066, 142858,
          148599,
          151528, 155624, 129348, 135438, 137332, 141428, 147726, 149620, 153716, 130636, 133637, 139085, 143181,
          146261,
          151339, 155435, 128936, 132813, 139474, 143570, 148291, 151762, 155858, 130284, 136003, 139051, 143147,
          145745,
          151373, 155469, 131413, 133457, 137367, 141463, 146334, 149662, 153758, 128799, 134345, 140088, 144184,
          146633,
          152376, 154572, 131732, 135705, 138213, 142185, 147789, 149404, 156097, 131559, 135629, 139756, 140755,
          146074,
          151654, 153919, 132361, 136028, 138450, 143462, 144935, 150333, 154630, 132296, 135718, 140531, 141974,
          148111,
          148776, 156050, 128703, 133786, 138659, 143438, 147712, 152061, 154475, 131309, 135823, 136575, 141532,
          145073,
          148750, 154014, 131496, 135218, 137817, 143123, 147506, 151398, 153668, 131461, 135086, 136856, 141838,
          147374,
          152209, 152937, 129967, 132394, 138740, 141156, 146715, 149581, 156706, 132314, 133737, 136763, 143782,
          146025,
          150913, 156331, 131591, 136438, 139931, 140700, 148726, 151176, 154749, 130151, 132995, 137049, 140980,
          146807,
          149026, 155739, 131591, 134519, 137276, 143943, 144691, 152822, 156821, 129544, 136104, 139106, 141989,
          145689,
          151698, 155927, 128965, 134513, 140431, 142757, 146422, 149944, 156078, 132069, 132621, 136584, 140690,
          148726,
          149941, 155173, 130961, 132981, 140345, 142303, 147089, 150650, 155466, 130889, 132403, 139092, 143055,
          146235,
          151247, 153176, 131894, 134770, 136907, 143511, 146801, 151703, 155799, 132326, 132873, 138474, 142570,
          147355,
          150208, 154833, 129465, 133350, 140213, 144553, 147066, 151167, 153996, 128936, 133973, 137812, 142771,
          146261,
          150331, 154427, 131445, 134955, 139474, 143570, 148241, 149655, 153751, 130380, 132686, 137367, 141463,
          146405,
          150187, 154014, 132151, 133052, 138488, 142349, 147259, 150082, 155755, 130334, 134971, 136613, 141855,
          147568,
          149712, 154637, 130284, 135686, 137972, 142820, 145844, 152525, 156621, 130318, 134290, 140237, 144333,
          146578,
          150260, 154356, 131503, 133081, 138724, 142068, 147974, 151272, 155108, 131337, 135912, 136706, 140802,
          148200,
          148994, 153090, 131413, 134140, 137142, 141238, 144961, 150232, 154328, 130998, 134434, 138630, 142040,
          148454,
          150776, 155313, 132185, 136443, 137593, 140983, 148731, 149881, 153977, 131283, 134047, 137341, 140715,
          146054,
          149175, 153271, 132151, 133391, 138828, 142176, 147181, 149925, 153170, 130380, 134472, 136887, 141689,
          146760,
          150918, 155014, 131542, 133025, 137944, 142726, 145313, 151837, 155599, 128965, 134253, 139902, 143903,
          146932,
          151521, 156172, 130784, 135562, 140370, 144466, 145847, 150129, 154225, 132298, 134045, 136669, 141937,
          147049,
          152095, 156827, 130972, 133330, 140476, 144572, 148728, 152719, 154534, 129376, 135083, 140250, 143140,
          146852,
          150544, 155766, 131834, 133272, 138428, 141653, 146576, 152497, 155475, 132262, 134579, 137474, 143601,
          146262,
          149553, 155527, 131175, 135272, 137858, 140754, 147560, 151975, 156542, 130491, 136148, 139763, 142567,
          148436,
          152051, 154855, 131559, 135410, 139176, 142638, 145048, 151932, 156126, 128703, 134506, 138109, 142690,
          147111,
          151622, 155724, 131719, 133456, 137683, 143650, 146715, 152123, 153147, 131591, 133737, 140447, 141952,
          148017,
          150882, 153268, 131591, 135729, 140549, 143746, 145539, 150481, 154616, 132314, 135695, 137168, 142755,
          147698,
          151662, 155863, 130151, 134519, 139917, 143975, 147128, 150592, 153180, 130961, 134840, 137856, 144533,
          146781,
          151955, 156599, 129544, 134346, 138129, 144170, 145689, 149350, 155799, 128936, 134032, 138474, 144077,
          147001,
          149684, 156923, 131732, 132695, 136785, 141830, 146430, 151275, 156423, 129336, 132981, 139287, 143205,
          147374,
          150092, 156640, 130715, 135715, 139835, 142135, 147988, 151865, 154650, 131894, 134770, 139415, 143511,
          147058,
          151703, 153706, 130972, 135837, 138266, 144553, 148654, 149341, 155484, 132314, 132632, 137486, 142905,
          146025,
          150681, 156174, 132314, 133737, 138594, 142577, 146807, 151873, 156301, 128690, 133561, 140124, 140788,
          148726,
          149875, 155311, 130547, 136366, 136692, 142579, 145086, 148918, 156472, 128936, 136003, 140088, 143181,
          146254,
          151373, 155469, 128983, 133766, 138125, 142726, 148212, 148907, 154901, 130334, 134971, 136613, 140709,
          146386,
          152168, 156264, 132151, 134098, 140258, 144333, 144682, 149699, 155837, 130193, 133973, 138580, 144302,
          146261,
          152494, 156590, 130636, 133637, 139850, 143946, 145925, 152138, 156234, 131324, 134174, 136951, 142221,
          148343,
          149239, 153335, 130284, 132813, 138944, 143040, 145101, 150413, 154509, 131413, 134290, 139735, 143147,
          146578,
          151339, 155435, 131337, 133025, 139187, 143831, 145313, 152023, 156119, 132185, 135912, 137367, 142068,
          148731,
          149881, 153977, 128983, 135780, 136887, 140983, 148068, 149175, 153271, 131283, 136443, 137593, 141689,
          148731,
          151232, 155328, 130998, 133052, 137944, 142726, 144961, 149629, 153725, 128571, 133766, 137972, 142584,
          147974,
          152650, 156746, 129851, 134191, 140362, 144458, 146479, 150232, 154328, 128936, 132673, 137374, 141470,
          144681,
          149727, 153823, 130284, 135686, 137142, 142040, 145161, 148971, 156343, 130193, 136343, 140386, 144482,
          148631,
          152674, 156770, 130863, 134447, 138805, 141463, 146735, 149655, 153751, 130636, 132830, 138125, 142221,
          145844,
          152023, 156119, 131108, 134290, 139959, 142820, 146578, 151012, 155108, 131020, 136055, 137367, 141463,
          146261,
          150413, 154509, 131337, 136003, 139735, 143831, 145226, 151093, 156621, 132185, 136443, 137593, 141689,
          148731,
          149175, 153271, 131413, 135912, 138847, 141238, 144961, 150232, 154328, 128936, 134191, 137944, 143147,
          147974,
          150260, 154356, 130284, 135686, 137142, 142040, 145161, 148971, 155927, 130193, 136343, 140386, 144482,
          148631,
          152674, 156770, 130863, 134447, 138805, 142901, 146735, 149655, 153751, 130636, 132830, 138125, 142221,
          145844,
          152023, 156119, 131108, 134290, 139959, 142820, 146578, 151012, 155108, 131020, 133973, 139187, 143283,
          146261,
          150413, 154509, 131337, 134200, 136493, 143831]])

    c = create_codes(generated_id)
    aud = run_onnx(c)
    create_audio(aud[0][0], "testing.wav")
